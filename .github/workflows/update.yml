# This workflow runs the Atlas Python script daily, updates the necessary files,
# and then directly deploys the new version via GitHub Pages artifacts.
#
# CRITICAL CHANGES:
# 1. Removed the 'git push' step (Step 5 of your original file) to fix the deployment conflict.
# 2. Added the two required jobs/steps for GitHub Pages deployment (Job: deploy-site).

name: üìä Daily Atlas Update

# Controls when the workflow is triggered
on:
  # 1. Manual trigger (for easy testing)
  workflow_dispatch:
 
  # 2. Scheduled trigger (runs 3 times daily)
  schedule:
    - cron: '0 6 * * *' # 6:00 AM UTC
    - cron: '0 12 * * *' # 12:00 PM (noon) UTC
    - cron: '0 18 * * *' # 6:00 PM UTC

jobs:
  run-atlas-update:
    runs-on: ubuntu-latest
    
    # Permissions required only for checkout/reading secrets in this job
    permissions:
      contents: read 
      
    steps:
      # 1. Checkout the repository code
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          # Only fetch the latest commit, as we are no longer pushing data back here
          fetch-depth: 1 

      # 2. Setup Python environment
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Install dependencies
      - name: üì¶ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Execute the Python script
      # This step must update the JSON data and any dependent static HTML files.
      - name: üèÉ Run Atlas Update Script
        run: python3 update_atlas.py
        env:
          # CORE KEYS
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
          # NEWS INTEGRATION KEYS
          GOOGLE_SEARCH_API_KEY: ${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_SEARCH_CX: ${{ secrets.GOOGLE_SEARCH_CX }}
          
          # ADDITIONAL INDICATOR KEYS
          VIX_API_KEY: ${{ secrets.VIX_API_KEY }}
          GOLD_API_KEY: ${{ secrets.GOLD_API_KEY }}
          FX_API_KEY: ${{ secrets.FX_API_KEY }}
          
      # 5. COMMIT AND PUSH STEP REMOVED: 
      # The git push step was removed to prevent the workflow chain from breaking.
      
      # 6. Upload static site files for deployment (CRITICAL STEP 1: Uploading the artifact)
      # This uploads the entire working directory (including the new data) for deployment.
      - name: üì¶ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # This path must contain your index.html and the data/ directory.
          path: './'


  deploy-site:
    # This deployment job only runs AFTER the run-atlas-update job successfully finishes.
    needs: run-atlas-update
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    runs-on: ubuntu-latest
    
    # Grant necessary permissions for deployment
    permissions:
      contents: read
      pages: write # <--- Essential for deployment
      id-token: write # <--- Essential for deployment

    steps:
      # 1. Deploy the uploaded artifact (CRITICAL STEP 2: Deploying the artifact)
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4