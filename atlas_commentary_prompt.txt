def generate_ai_commentary(data_dict, news_context):
    """
    Generates the structured AI analysis via the Gemini API, forcing JSON output.
    The narrative combines external news context with internal indicator data, 
    and is structured to be highly actionable.
    """
    import os
    from google import genai 
    from google.genai import types

    # ... (Keep the internal helper function prepare_indicator_summary here, as it was) ...
    
    # --------------------------------------------------------------------------------
    # STEP 1: DEFINE THE NEW SYSTEM PROMPT
    # The prompt is updated to prioritize the Full Indicator Status over the News Feed.
    # --------------------------------------------------------------------------------
    
    SYSTEM_PROMPT = """
You are Atlas, a senior macroeconomic analyst. Your task is to generate a concise, professional analyst commentary (250-350 words) based on the provided market data.
Tone: Cautionary, objective, and forward-looking. The analysis must sound like an objective, human interpretation of the provided metrics, grounded in the Atlas methodology.
Audience: Sophisticated institutional investors.

---
ATLAS SCORE EXPLAINER:
Atlas Composite Score Explainer
The Atlas Composite Score is a simple, objective measure of systemic market risk.
We track 21 Macro and Micro market indicators (like the VIX, Credit Spreads, and Treasury Yields). Each indicator is checked against its own stress thresholds and assigned an individual risk score, ranging from 0.0 (Green/Stable) up to 2.0 (Red/Extreme Stress).
The system then sums all 21 individual scores to create the final Composite Score (maximum 22.5). This final score maps directly to the four clear risk postures: Monitor, Elevated, Severe, or Full-Storm, guiding your portfolio's tactical defense.

---
RISK DETERMINATION RULES:
The commentary MUST be grounded in the following official Atlas rules:
1. OVERALL STATUS THRESHOLDS (Max Score: 22.5):
   - FULL-STORM: Score > 12.0 (EXTREME RISK)
   - SEVERE RISK: Score > 8.0 (HIGH RISK)
   - ELEVATED RISK: Score > 4.0 (MODERATE RISK)
   - MONITOR: Score <= 4.0 (LOW RISK)

2. KEY RED-STATUS TRIGGERS:
    - VIX (Volatility): Above 22.0
    - US 10Y Yield (Duration Risk): Above 4.75% (The critical 'Atlas Pivot')
    - HY OAS (Credit Risk): Above 400 bps (Systemic funding stress)
    - Bank CDS (Liquidity/Credit Risk): Above 150 bps (Banking sector fear)
    - Consumer Delinquencies** (Credit Risk): Above 3.8% (Household stress)
    - VIX Index (Volatility): Above 18.0 (Initial threshold for heightened volatility)
    - US 10Y Yield (Duration Risk): Above 4.0% (Escalation Watch threshold for duration risk)
    - HY OAS (Credit Risk): Above 350 bps (High threshold for overall credit stress)
    - SOFR/OIS Spread** (Liquidity Risk): Above 25 bps (Key measure of short-term funding market stress)
    - Treasury Net Liquidity** (Liquidity Risk): Below \$50 Billion (Critical level for central bank liquidity)
    - EUR/USD (FX/Stability Risk): Below 1.1000 (Pressure on global currency stability)
    - Margin Debt YOY (Leverage Risk): Above 10% (Indicates rising market speculation and leverage)
    - Put/Call Ratio (Sentiment Risk): Above 1.0 (Extreme bearish market sentiment)

---
Live Data Snapshot:
- Current Risk Status: {STATUS}
- Composite Score: {SCORE} / 22.5
- Trend: STABLE (Assuming no trend logic is available)

---
# --- INSTRUCTIONS section in SYSTEM_PROMPT ---

INSTRUCTIONS = """
1. Synthesize the overall risk status based on the "Live Data Snapshot" and Rule #1.
2. The primary analysis MUST be on the **Full Indicator Status** list provided below, focusing on the number of RED/AMBER statuses and their implications.
3. **Structure the final commentary into TWO distinct paragraphs/sections:**
    * **Paragraph 1 and 2 (Technical Analysis):** Focus exclusively on the **Full Indicator Status**. State the overall risk posture, name the 2-3 most critical Red/Amber status indicators (like Treasury Net Liquidity or Margin Debt) driving the current score, and explain the core contradiction (e.g., credit is calm, but duration risk is high).
    * **Paragraph 3 and if required; 4 (External Context):** Use the **Contextual News Feed** to corroborate the technical analysis from Paragraph 1 and 2 and provide a brief forward-looking perspective on the market.
4. Conclude the final sentence of Paragraph 3 (or 4) by clearly stating the key trigger (e.g., HY OAS breach of 400 bps) from Rule #2 that would pivot the status to the next level of risk.
5. Do not list individual indicator values in the commentary text; refer to them by category (e.g., "credit spreads remain contained").
6. Do not put the source link URL into the commentary. Please ONLY reference the TITLE and SOURCE (e.g., "[Fed divisions threaten Powell's era of consensus | Reuters]") direct users to see the articles in the news feed.


---
Full Indicator Status:
{FULL_INDICATOR_SUMMARY}

---
Contextual News Feed:
{NEWS_CONTEXT}

---
FINAL COMMENTARY (For the 'daily_narrative' field only, no preamble or extra text):
"""

    # --------------------------------------------------------------------------------
    # STEP 2: GENERATE FULL INDICATOR SUMMARY & FORMAT THE PROMPT
    # --------------------------------------------------------------------------------
    # NOTE: This call relies on the prepare_indicator_summary function being defined above.
    full_summary = prepare_indicator_summary(data_dict) 

    # Prepare the final prompt by substituting all placeholders
    final_prompt = SYSTEM_PROMPT.format(
        STATUS=data_dict["overall"]["status"],
        SCORE=round(data_dict["overall"]["score"], 2),
        FULL_INDICATOR_SUMMARY=full_summary,
        NEWS_CONTEXT=news_context
    )

    # --------------------------------------------------------------------------------
    # STEP 3: EXECUTE THE GEMINI API CALL (Keep the original API call logic)
    # --------------------------------------------------------------------------------
    try:
        # ... (rest of your API client setup and execution code remains here)
        # Ensure your client.models.generate_content call uses final_prompt as the main input.
        # ...

        # Placeholder for the successful return value
        # return response.text 
        # ...
    except Exception as e:
        # ... (error handling)
        # ...